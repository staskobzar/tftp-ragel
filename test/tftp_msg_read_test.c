#include <stdarg.h>
#include <stddef.h>
#include <setjmp.h>
#include <cmocka.h>

#include "tftp_msg.h"

/*
 * TFTP Packets mocks.
 */
char raw_rrq[] = {0x00,0x01,0x66,0x6f,0x6f,
                  0x2e,0x63,0x00,0x6e, 0x65,0x74,0x61,0x73,0x63,
                  0x69,0x69,0x00};

char raw_case_rrq[] = {0x00,0x01,0x7a,0x6f,
                       0x69,0x70,0x65,0x72, 0x2e,0x72,0x75,0x6e,
                       0x00,0x4d,0x41,0x69, 0x6c,0x00};

char raw_wrq[] = {0x00,0x02,0x52,0x45, 0x41,0x44,0x4d,0x45,
                  0x00,0x6f,0x63,0x74, 0x65,0x74,0x00 };

char raw_data[] = {0x00,0x03,0x40,0xe7, 0x20,0x20,0x54,0x68, 0x65,0x20,0x47,0x4e, 0x55,0x20,0x47,0x65, 0x6e,0x65,0x72,0x61, 0x6c,0x20,0x50,0x75, 0x62,0x6c,0x69,0x63,
  0x20,0x4c,0x69,0x63, 0x65,0x6e,0x73,0x65, 0x20,0x69,0x73,0x20, 0x61,0x20,0x66,0x72, 0x65,0x65,0x2c,0x20, 0x63,0x6f,0x70,0x79, 0x6c,0x65,0x66,0x74, 0x20,0x6c,0x69,0x63,
  0x65,0x6e,0x73,0x65, 0x20,0x66,0x6f,0x72, 0x0a,0x73,0x6f,0x66, 0x74,0x77,0x61,0x72, 0x65,0x20,0x61,0x6e, 0x64,0x20,0x6f,0x74, 0x68,0x65,0x72,0x20, 0x6b,0x69,0x6e,0x64,
  0x73,0x20,0x6f,0x66, 0x20,0x77,0x6f,0x72, 0x6b,0x73,0x2e,0x0a, 0x0a,0x20,0x20,0x54, 0x68,0x65,0x20,0x6c, 0x69,0x63,0x65,0x6e, 0x73,0x65,0x73,0x20, 0x66,0x6f,0x72,0x20,
  0x6d,0x6f,0x73,0x74, 0x20,0x73,0x6f,0x66, 0x74,0x77,0x61,0x72, 0x65,0x20,0x61,0x6e, 0x64,0x20,0x6f,0x74, 0x68,0x65,0x72,0x20, 0x70,0x72,0x61,0x63, 0x74,0x69,0x63,0x61,
  0x6c,0x20,0x77,0x6f, 0x72,0x6b,0x73,0x20, 0x61,0x72,0x65,0x20, 0x64,0x65,0x73,0x69, 0x67,0x6e,0x65,0x64, 0x0a,0x74,0x6f,0x20, 0x74,0x61,0x6b,0x65, 0x20,0x61,0x77,0x61,
  0x79,0x20,0x79,0x6f, 0x75,0x72,0x20,0x66, 0x72,0x65,0x65,0x64, 0x6f,0x6d,0x20,0x74, 0x6f,0x20,0x73,0x68, 0x61,0x72,0x65,0x20, 0x61,0x6e,0x64,0x20, 0x63,0x68,0x61,0x6e,
  0x67,0x65,0x20,0x74, 0x68,0x65,0x20,0x77, 0x6f,0x72,0x6b,0x73, 0x2e,0x20,0x20,0x42, 0x79,0x20,0x63,0x6f, 0x6e,0x74,0x72,0x61, 0x73,0x74,0x2c,0x0a, 0x74,0x68,0x65,0x20,
  0x47,0x4e,0x55,0x20, 0x47,0x65,0x6e,0x65, 0x72,0x61,0x6c,0x20, 0x50,0x75,0x62,0x6c, 0x69,0x63,0x20,0x4c, 0x69,0x63,0x65,0x6e, 0x73,0x65,0x20,0x69, 0x73,0x20,0x69,0x6e,
  0x74,0x65,0x6e,0x64, 0x65,0x64,0x20,0x74, 0x6f,0x20,0x67,0x75, 0x61,0x72,0x61,0x6e, 0x74,0x65,0x65,0x20, 0x79,0x6f,0x75,0x72, 0x20,0x66,0x72,0x65, 0x65,0x64,0x6f,0x6d,
  0x20,0x74,0x6f,0x0a, 0x73,0x68,0x61,0x72, 0x65,0x20,0x61,0x6e, 0x64,0x20,0x63,0x68, 0x61,0x6e,0x67,0x65, 0x20,0x61,0x6c,0x6c, 0x20,0x76,0x65,0x72, 0x73,0x69,0x6f,0x6e,
  0x73,0x20,0x6f,0x66, 0x20,0x61,0x20,0x70, 0x72,0x6f,0x67,0x72, 0x61,0x6d,0x2d,0x2d, 0x74,0x6f,0x20,0x6d, 0x61,0x6b,0x65,0x20, 0x73,0x75,0x72,0x65, 0x20,0x69,0x74,0x20,
  0x72,0x65,0x6d,0x61, 0x69,0x6e,0x73,0x20, 0x66,0x72,0x65,0x65, 0x0a,0x73,0x6f,0x66, 0x74,0x77,0x61,0x72, 0x65,0x20,0x66,0x6f, 0x72,0x20,0x61,0x6c, 0x6c,0x20,0x69,0x74,
  0x73,0x20,0x75,0x73, 0x65,0x72,0x73,0x2e, 0x20,0x20,0x57,0x65, 0x2c,0x20,0x74,0x68, 0x65,0x20,0x46,0x72, 0x65,0x65,0x20,0x53, 0x6f,0x66,0x74,0x77, 0x61,0x72,0x65,0x20,
  0x46,0x6f,0x75,0x6e, 0x64,0x61,0x74,0x69, 0x6f,0x6e,0x2c,0x20, 0x75,0x73,0x65,0x20, 0x74,0x68,0x65,0x0a, 0x47,0x4e,0x55,0x20, 0x47,0x65,0x6e,0x65, 0x72,0x61,0x6c,0x20,
  0x50,0x75,0x62,0x6c, 0x69,0x63,0x20,0x4c, 0x69,0x63,0x65,0x6e, 0x73,0x65,0x20,0x66, 0x6f,0x72,0x20,0x6d, 0x6f,0x73,0x74,0x20, 0x6f,0x66,0x20,0x6f, 0x75,0x72,0x20,0x73,
  0x6f,0x66,0x74,0x77, 0x61,0x72,0x65,0x3b};

char raw_bin_data[] = {0x00,0x03,0x51,0x0f,0xfc,0xd0,0xd4,0xf4,0x14,0x86,0x98,0xce,0x50,0x5c,0xac,0x7d,0x37,0x98,0x47,0x38,0x94,0x1e,0xf4,0xa0,0x86,0xcb,0x7c,0xfb,
  0xba,0x7d,0x5f,0x3f,0xf1,0xde,0xc7,0x95,0x35,0x0d,0xf6,0xcf,0x5e,0xef,0x4e,0x48,0x3b,0xd5,0xcc,0x44,0x51,0x20,0xed,0x50,0xce,0xbf,0x5d,0x89,
  0x45,0xe9,0xcf,0x1a,0x45,0x07,0x7b,0xae,0xb8,0x80,0xd6,0x3b,0xf0,0x02,0x87,0xc0,0xcf,0xe7,0x08,0x76,0x3c,0x2b,0xe4,0xf2,0x2b,0x0d,0x93,0x9b,
  0xfe,0x66,0x3f,0x63,0xa2,0x37,0xdd,0x60,0x62,0x7d,0xa8,0x45,0x79,0x8a,0xdb,0x15,0x3c,0xdb,0x28,0x1f,0xce,0xe8,0x33,0xa5,0x30,0xf3,0x64,0x36,
  0xcb,0xc8,0xd8,0x49,0x1b,0x80,0x57,0xdc,0xb8,0xfa,0x1a,0xd4,0xbd,0x90,0x69,0xfe,0x4d,0x4c,0x62,0xb5,0xc8,0xd6,0x42,0xb1,0xd8,0xea,0xdf,0xfb,
  0xb3,0x10,0x79,0x8d,0xd7,0xb0,0xc3,0x5b,0x8a,0xd8,0x9f,0xae,0x32,0x2d,0xb2,0xfa,0x03,0x72,0xa5,0xc7,0x84,0x6c,0x64,0xbd,0xe2,0xf7,0x0b,0x48,
  0xdf,0x54,0xd4,0x65,0xac,0xd1,0x8b,0xdc,0x77,0x88,0x04,0x1e,0xaf,0x9d,0x9d,0x46,0xc4,0xe5,0x09,0x29,0xb9,0x18,0xb8,0xe3,0xab,0xe8,0xd3,0xb5,
  0x72,0x2c,0xea,0xe1,0xd2,0x1b,0x6b,0x1c,0x91,0x14,0xd3,0xdf,0x52,0xae,0xcf,0x31,0xdb,0xa1,0x6a,0xa5,0x40,0x21,0x37,0xfe,0x44,0x8f,0xa0,0x7a,
  0xf2,0xd1,0x20,0x7c,0x6f,0x58,0x30,0x66,0x3e,0x8f,0x02,0x2a,0x0c,0x74,0xe7,0x2b,0x7d,0x43,0x97,0xfc,0xe1,0xf0,0x30,0x6e,0x4e,0x8f,0x86,0x47,
  0x11,0xd3,0x58,0xa3,0x87,0x4b,0x72,0xfe,0xef,0x4d,0xd1,0x79,0xbf,0x15,0x70,0x41,0x17,0x8d,0xfb,0xef,0x20,0x29,0x44,0x40,0x70,0x6d,0x93,0xbc,
  0x34,0xba,0x86,0x95,0xaf,0xf6,0x92,0xee,0xbc,0x39,0x33,0xb7,0x3a,0x53,0xe8,0xce,0xcc,0xac,0x6e,0xde,0x9f,0xca,0x8f,0xf2,0x5d,0x43,0x0d,0xc1,
  0x6d,0xe3,0xed,0xad,0xfe,0x60,0xda,0x06,0x84,0xa2,0xa9,0xc9,0x3b,0x69,0x78,0x8b,0x42,0xd7,0x95,0x5d,0xd5,0x3c,0xc7,0x6e,0x31,0x9c,0xdb,0x2d,
  0xa8,0x90,0x57,0x51,0x5e,0x4d,0x3f,0x43,0xa3,0x45,0x7c,0x47,0xcd,0x27,0x10,0x4d,0x00,0xd3,0x37,0x6a,0x0c,0xdf,0xf5,0x27,0xd6,0xdb,0x51,0x90,
  0x16,0x80,0x1c,0xa3,0xe4,0xc4,0x30,0xfd,0xca,0x05,0x87,0x8d,0xc5,0xe1,0x5c,0xb2,0x53,0xd9,0x0d,0x3a,0xf3,0xd6,0xd7,0x9a,0x16,0x7d,0x58,0xb4,
  0xdf,0xef,0x54,0xbf,0xd0,0x35,0xa2,0x65,0x8c,0x62,0x2a,0xd0,0xe4,0x6c,0x3f,0x18,0x0d,0x67,0x8f,0xac,0x3c,0x07,0x01,0x0c,0xab,0xaf,0xcc,0x8d,
  0x0e,0x3d,0xd6,0xdc,0xee,0xa4,0x61,0x6d,0xe5,0x73,0x70,0x1d,0x93,0x11,0x53,0xb2,0xf8,0x77,0xf2,0xb2,0xb0,0x6d,0x70,0x0e,0xb9,0x1f,0xed,0x4d,
  0xd8,0x7d,0x52,0x18,0x0b,0x63,0x9d,0x28,0xbe,0x20,0x4c,0xb6,0x60,0x1b,0xfb,0x02,0xb0,0x08,0x2f,0x47,0x3a,0x30,0x7d,0x3c,0xae,0xc7,0x82,0x9f,
  0x66,0xe7,0xcd,0x1d,0x32,0xae,0x20,0x72,0x4e,0x0d,0xb6,0x55,0xf4,0xbe,0xb4,0x7a,0xef,0x48,0x9c,0x05,0xed,0xdb,0xa6,0x48,0xda,0x74,0x91,0x7e,
  0xa3,0xd2,0xd0,0xdd,0xd8,0x0b,0xae,0x96,0x17,0x50,0xc3,0x75 };

char raw_last_data[] = { 0x00,0x03,0x00,0x03,0x67,0x73,0x2e,0x0a };

char raw_ack[] = { 0x00,0x04,0x20,0x3d };

char raw_error[] = { 0x00,0x05,0x00,0x01, 0x46,0x69,0x6c,0x65,
                     0x20,0x6e,0x6f,0x74, 0x20,0x66,0x6f,0x75,
                     0x6e,0x64,0x00 };
/*
 * Setup and teardown for create message tests.
 */
static int setup(void **state) {
  apr_pool_t *mp;

  apr_initialize();
  apr_pool_create(&mp, NULL);

  *state = mp;

  return 0;
}

static int teardown(void **state) {
  apr_pool_destroy(*state);
  apr_terminate();
  return 0;
}


/*
 * Testing functions.
 */

/* Test read RRQ tftp packet. */
// ----------------------------------
static void read_rrq_pack_test (void **state)
{
  char filename[] = "foo.c";
  char mode[] = "netascii";
  tftp_pack *pack = tftp_packet_read(raw_rrq, sizeof(raw_rrq), *state);
  assert_int_equal (pack->opcode, E_RRQ);
  assert_string_equal (pack->data->rq.filename, filename);
  assert_int_equal (pack->data->rq.len_filename, strlen(filename));
  assert_string_equal (pack->data->rq.mode, mode);
  assert_int_equal (pack->data->rq.len_mode, strlen(mode));
  assert_int_equal (pack->data->rq.e_mode, E_ASCII);
}

/* Test read WRQ tftp packet. */
// ----------------------------------
static void read_wrq_pack_test (void **state)
{
  char filename[] = "README";
  char mode[] = "octet";
  tftp_pack *pack = tftp_packet_read(raw_wrq, sizeof(raw_wrq), *state);
  assert_int_equal (pack->opcode, E_WRQ);
  assert_string_equal (pack->data->rq.filename, filename);
  assert_int_equal (pack->data->rq.len_filename, strlen(filename));
  assert_string_equal (pack->data->rq.mode, mode);
  assert_int_equal (pack->data->rq.len_mode, strlen(mode));
  assert_int_equal (pack->data->rq.e_mode, E_OCTET);
}

/* Test mode W/RRQ case insensetive. */
// ----------------------------------
static void read_caseins_rrq_pack_test (void **state)
{
  char filename[] = "zoiper.run";
  char mode[] = "MAil";
  tftp_pack *pack = tftp_packet_read(raw_case_rrq, sizeof(raw_case_rrq), *state);
  assert_int_equal (pack->opcode, E_RRQ);
  assert_string_equal (pack->data->rq.filename, filename);
  assert_int_equal (pack->data->rq.len_filename, strlen(filename));
  assert_string_equal (pack->data->rq.mode, mode);
  assert_int_equal (pack->data->rq.len_mode, strlen(mode));
  assert_int_equal (pack->data->rq.e_mode, E_MAIL);
}


/* Test read text DATA tftp packet. */
// ----------------------------------
static void read_data_pack_test (void **state)
{
  char  data_str[] = "  The GNU General Public License is a free";
  char *data_p = data_str;
  tftp_pack *pack = tftp_packet_read(raw_data, sizeof(raw_data), *state);
  assert_int_equal (pack->opcode, E_DATA);
  assert_int_equal (pack->data->data.block, 16615);
  assert_int_equal (pack->data->data.length, 512);

  char *data_recv = apr_pstrndup (*state, pack->data->data.data, strlen(data_str));
  assert_string_equal (data_p, data_recv);
}

/* Test read text LAST DATA tftp packet. */
// ----------------------------------
static void read_last_data_pack_test (void **state)
{
  char  data_str[] = "gs.\n";
  char *data_p = data_str;
  tftp_pack *pack = tftp_packet_read(raw_last_data, sizeof(raw_last_data), *state);
  assert_int_equal (pack->opcode, E_DATA);
  assert_int_equal (pack->data->data.block, 3);
  assert_int_equal (pack->data->data.length, 4);

  assert_string_equal (data_p, pack->data->data.data);
}

/* Test read binary DATA tftp packet. */
// ----------------------------------
#include <stdio.h>
static void read_bin_data_pack_test (void **state)
{
  int i = 0;
  tftp_pack *pack = tftp_packet_read(raw_bin_data, sizeof(raw_bin_data), *state);
  assert_int_equal (pack->opcode, E_DATA);
  assert_int_equal (pack->data->data.block, 20751);
  assert_int_equal (pack->data->data.length, 512);
  // tests
  for (i; i< 512; i++) {
    assert_int_equal (raw_bin_data[i + 4], pack->data->data.data[i]);
  }
}

/* Test read ACK tftp packet. */
// ----------------------------------
static void read_ack_pack_test (void **state)
{
  tftp_pack *pack = tftp_packet_read(raw_ack, sizeof(raw_ack), *state);
  assert_int_equal (pack->opcode, E_ACK);
  assert_int_equal (pack->data->ack.block, 8253);
}

/* Test read ERROR tftp packet. */
// ----------------------------------
static void read_error_pack_test (void **state)
{
  char msg[] = "File not found";
  char *data_p = msg;
  tftp_pack *pack = tftp_packet_read(raw_error, sizeof(raw_error), *state);
  assert_int_equal (pack->opcode, E_ERROR);
  assert_int_equal (pack->data->error.ercode, 0x01);
  assert_string_equal (data_p, pack->data->error.msg);
  assert_int_equal (pack->data->error.msg_len, 14);
}

/* Test invalid tftp packet. */
// ----------------------------------
static void read_invalid_pack_test (void **state)
{
  char raw_invalid[] = {0x00,0x0f,0x66,0x6f,0x6f, 0x2e,0x63,0x00,0x6e, 0x65,0x74,0x61,0x73,0x63, 0x69,0x69,0x00};
  assert_null(tftp_packet_read(raw_invalid, sizeof(raw_invalid), *state));
}

/*
 * Run all tests.
 */
int main(void)
{
  const struct CMUnitTest tests[] = {
    cmocka_unit_test_setup_teardown (read_rrq_pack_test, setup, teardown),
    cmocka_unit_test_setup_teardown (read_caseins_rrq_pack_test, setup, teardown),
    cmocka_unit_test_setup_teardown (read_wrq_pack_test, setup, teardown),
    cmocka_unit_test_setup_teardown (read_data_pack_test, setup, teardown),
    cmocka_unit_test_setup_teardown (read_bin_data_pack_test, setup, teardown),
    cmocka_unit_test_setup_teardown (read_last_data_pack_test, setup, teardown),
    cmocka_unit_test_setup_teardown (read_ack_pack_test, setup, teardown),
    cmocka_unit_test_setup_teardown (read_error_pack_test, setup, teardown),
    cmocka_unit_test_setup_teardown (read_invalid_pack_test, setup, teardown),
  };
  return cmocka_run_group_tests_name("tftpclient library tests", tests, NULL, NULL);
}
